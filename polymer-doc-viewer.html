<script src="highlight.js/highlight.pack.js"></script>

<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../polymer-ajax/polymer-ajax.html">
<link rel="import" href="../polymer-layout/polymer-layout.html">
<link rel="import" href="../polymer-flex-layout/polymer-flex-layout.html">
<link rel="import" href="../polymer-media-query/polymer-media-query.html">
<link rel="import" href="../polymer-grid-layout/polymer-grid-layout.html">

<link rel="import" href="../polymer-ui-menu-item/polymer-ui-menu-item.html">
<link rel="import" href="../polymer-ui-submenu-item/polymer-ui-submenu-item.html">
<link rel="import" href="../polymer-ui-menu/polymer-ui-menu.html">
<link rel="import" href="../polymer-ui-toolbar/polymer-ui-toolbar.html">
<link rel="import" href="../polymer-ui-icon-button/polymer-ui-icon-button.html">

<link rel="import" href="../marked-js/marked-js.html">

<polymer-element name="polymer-doc-viewer" attributes="url">
  <template>
    <link rel="stylesheet" href="highlight.js/styles/default.css">
    <link rel="stylesheet" href="polymer-doc-viewer.css">

    <polymer-ajax url="{{url}}" response="{{data}}" handleAs="json" auto></polymer-ajax>
    <polymer-grid-layout id="grid" on-polymer-grid-layout="{{gridLayout}}"></polymer-grid-layout>

    <div id="navigation" offscreen="basement" style="overflow-y: scroll;">
      <polymer-ui-menu selected="0" id="menu">
        <template repeat="{{classes}}">
          <polymer-ui-menu-item><a href="#{{name}}">{{name}}</a></polymer-ui-menu-item>
        </template>
      </polymer-ui-menu>
    </div>

    <div id="docs" flex on-marked-js-highlight="{{hilight}}">
      <div id="docsInner" flex>
        <div id="fixed">
          <div class="header">
            <polymer-ui-icon-button icon="menu" on-tap="{{toggleNav}}" active="{{navOpen}}"></polymer-ui-icon-button>
            &nbsp;<span id="fixedTopic" class="element"></span>
          </div>
        </div>

        <template repeat="{{class in classes}}">
          <a id="{{class.name}}" class="element"></a>
          <div class="header topic">
            <polymer-ui-icon-button on-tap="{{toggleLayout}}" icon="menu" style="visibility: hidden;"></polymer-ui-icon-button>
            &nbsp;<span class="element">{{class.name}}</span>
          </div>
  
          <div>
            <polymer-flex-layout></polymer-flex-layout>

            <div class="summary">
              <section class="box">
                <div class="ntitle">Methods</div>
                <template repeat="{{class.methods}}">
                  <span class="name method">{{name}}</span><br/>
                </template>
              </section>
                <section class="box">
                <div class="ntitle">Attributes</div>
                <template repeat="{{class.attributes}}">
                  <span class="name nattribute">{{name}}</span><br/>
                </template>
              </section>
              <section class="box">
                <div class="ntitle">Events</div>
                <template repeat="{{class.events}}">
                  <span class="name event">{{name}}</span><br>
                </template>
              </section>
            </div>

            <div flex>
              <div style="padding: 16px;">
                <section class="box">
                  Module<br>
                  <span class="name">{{class.module}}</span>
                </section>

                <section class="box">
                  <div class="ntitle">Description</div>
                  <marked-js>{{class.description}}</marked-js>
                </section>

                <section class="box">
                  <div class="ntitle">Methods</div>
                  <template repeat="{{class.methods}}">
                    <span class="name method">{{name}}</span>
                    <marked-js>{{description}}</marked-js>
                  </template>
                </section>

                <section class="box">
                  <div class="ntitle">Attributes</div>
                  <template repeat="{{class.attributes}}">
                    <span class="name nattribute">{{name}}</span><span class="name type">{{type}}</span>
                    <marked-js>{{description}}</marked-js>
                    <br>
                  </template>
                </section>

                <section class="box">
                  <div class="ntitle">Events</div>
                  <template repeat="{{class.events}}">
                    <span class="name event">{{name}}</span>
                    <marked-js>{{description}}</marked-js>
                    <br>
                  </template>
                </section>
              </div>
            </div>
          </div>
        </template>

        <hr>
        <div style="height: 512px"></div>
      </div>
    </div>
  </template>
  <script>
    Polymer('polymer-doc-viewer', {
      data: null,
      route: '',
      layouts: {
        open: [
          [1, 2, 2]
        ],
        closed: [
          [2, 2]
        ],
      },
      navOpen: true,
      ready: function() {
        window.addEventListener('hashchange', this.parseLocationHash.bind(this));
        // TODO(sjmiles): manual because flatiron-director didn't work, find out why
        this.parseLocationHash();
        // TODO(sjmiles): improve method of configuring grid
        this.$.grid.nodes = [this.$.navigation, this.$.docs];
        this.$.grid.layout = this.layouts.open;
        // TODO(sjmiles): make onscroll listenable via on-scroll
        this.$.docs.onscroll = this.docsScroll.bind(this);
      },
      onMutation: function(node, listener) {
        var observer = new MutationObserver(function() {
          listener.call(this, observer);
          observer.disconnect();
        }.bind(this));
        observer.observe(node, {childList: true, subtree: true});
      },
      parseLocationHash: function() {
        this.route = window.location.hash.slice(1);
      },
      gridLayout: function() {
        // TODO(sjmiles): the 'fixed' header bar is relative to the screen
        // to position it dynamically we need to know offsetLeft of the
        // docs panel after the first layout.
        if (!this.fixedLeft) {
          this.fixedLeft = this.$.docs.offsetLeft;
          this.$.fixed.style.display = 'block';
          this.effectLayout();
        }
        this.$.docs.classList.add('animate');
        this.$.fixed.classList.add('animate');
      },
      hilight: function(event, detail, sender) {
        //console.log('highlight', event.target, sender);
        detail.code = hljs.highlightAuto(detail.code).value;
      },
      docsNodeChanged: function(observer) {
        // initialize scrolling side-effects
        this.docsScroll();
        //console.log('docsNodeChanged');
      },
      docsScroll: function() {
        var t = this.$.docs.scrollTop + 80;
        var hcs = this.$.docsInner.querySelectorAll('.topic');
        for (var i = 0, hc; hc = hcs[i]; i++) {
          if (t >= hc.offsetTop && (!hcs[i+1] || t < hcs[i+1].offsetTop)) {
            var h = hc.querySelector('.element');
            if (h) {
              this.$.fixedTopic.innerText = h.innerText;	
            }
            return;
          }
        }
      },
      routeChanged: function() {
        var anchor = this.shadowRoot.querySelector('a[id="' + this.route + '"]');
        if (anchor) {
          anchor.scrollIntoView();
        }
      },
      toggleNav: function(event, detail, sender) {
        // TODO(sjmiles): would be nice to automate this common action
        this.navOpen = !this.navOpen;
      },
      navOpenChanged: function() {
        // TODO(sjmiles): would be nice to automate this common action
        this.effectLayout();
      },
      effectLayout: function() {
        this.$.grid.layout = this.navOpen ? this.layouts.open : this.layouts.closed;
        this.$.fixed.style.left = this.navOpen ? this.fixedLeft + 'px' : '0px';
        // ensure transitions start at the same time (still async)
        Platform.flush();
      },
      dataChanged: function() {
        // schedule more work when changes here propagate to DOM
        this.onMutation(this.$.docs, this.docsNodeChanged);
        // collate raw data for display
        // construct an array from modules map
        this.modules = mapdex(this.data.modules);
        // construct an array from classes map
        this.classes = mapdex(this.data.classes);
        // sort class array by name (case insensitive)
        this.classes.sort(function (a,b) {
          var an = a.name.toLowerCase(), bn = b.name.toLowerCase();
          return (an < bn) ? -1	: (an > bn) ? 1	: 0;
        });
        // construct an index of classes by module
        this.modules.forEach(function(m) {
          m.classNames = Object.keys(m.classes);
        });
        // collate classitems by class
        collate(this.data.classitems, function(item) {
          return this.data.classes[item.class];
        }.bind(this), function() {
          return 'items';
        });
        // collate class.items by itemtype
        this.classes.forEach(function(c) {
          var itemtype = '';
          if (c.items) {
            collate(c.items, function(item) {
              itemtype = item.itemtype + 's';
              return item.itemtype ? c : null;
            }, function() {
              return itemtype;
            });
          }
        });
        // filters
        function mapdex(map) {
          var a = [];
          for (var n in map) {
            a.push(map[n]);
          }
          return a;
        };
        function collate(list, getCrossIndex, getCollation) {
          list.forEach(function(item) {
            var r = getCrossIndex(item);
            if (r) {
              var c = getCollation(r);
              (r[c] || (r[c] = [])).push(item);
            }
          });
        };
      }
    });
  </script>
</polymer-element>
